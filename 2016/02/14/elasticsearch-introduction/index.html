<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>ElasticSearch 入门 · 文木逝水</title><meta name="description" content="ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/jiemoon" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">ElasticSearch 入门</h1><div class="post-time">Feb 14, 2016</div><div class="post-content"><h3 id="什么是ElasticSearch？"><a href="#什么是ElasticSearch？" class="headerlink" title="什么是ElasticSearch？"></a>什么是ElasticSearch？</h3><blockquote>
<ol>
<li>ElasticSearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。</li>
<li>Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是第二流行的企业搜索引擎。设计用于<a href="http://baike.baidu.com/view/1316082.htm" target="_blank" rel="external">云计算</a>中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</li>
</ol>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="CentOS-6-6"><a href="#CentOS-6-6" class="headerlink" title="CentOS 6.6"></a>CentOS 6.6</h4><ol>
<li>安装 <code>Java</code> 环境</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install java-1.8.0-openjdk.x86_64</span><br></pre></td></tr></table></figure>
<ol>
<li>安装 elasticsearch</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前最新版本是 2.2.0，我们这边使用 rpm 来安装</span></span><br><span class="line">$ wget https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/rpm/elasticsearch/2.2.0/elasticsearch-2.2.0.rpm</span><br><span class="line">$ rpm -ivh elasticsearch-2.2.0.rpm</span><br></pre></td></tr></table></figure>
<h4 id="MacOSX"><a href="#MacOSX" class="headerlink" title="MacOSX"></a>MacOSX</h4><ol>
<li><p>jdk 可以去官网直接下载然后安装</p>
</li>
<li><p>安装 ElasticSearch</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle install elasticsearch</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>如果是 <code>MacOSX</code> 系统，则相对比较简单。由于服务器使用的是 <code>CentOS 6.6</code>，因此着重介绍 <code>CentOS</code> 下的配置</p>
<p>安装成功后，会在 /etc/elasticsearch 生成两个配置文件：</p>
<ul>
<li>elasticsearch.yml - Elasticsearch 服务配置文件</li>
<li>logging.yml 日志配置文件</li>
</ul>
<p>打开 /etc/elasticsearch/elasticsearch.yml，对文件中的如下项进行修改，记得要去掉前面的 <code>#</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: my-cluster <span class="comment"># 集群名称</span></span><br><span class="line">node.name: my-node <span class="comment"># 节点名称</span></span><br><span class="line"></span><br><span class="line">path.data: /xxx/elasticsearch/data <span class="comment"># 数据存放路径</span></span><br><span class="line">path.logs: /xxx/elasticsearch/logs <span class="comment"># 日志存放路径</span></span><br><span class="line"></span><br><span class="line">network.host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># 只允许本机访问</span></span><br></pre></td></tr></table></figure>
<p>修改后，保存。启动 elasticsearch 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service elasticsearch start</span><br></pre></td></tr></table></figure>
<p>此外，我们可以把 <code>elasticsearch</code> 设置为开机自启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chkconfig --add elasticsearch</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>访问 <a href="http://localhost:9200" target="_blank" rel="external">http://localhost:9200</a> ，如果出现如下响应，则服务运行成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bash-4.1<span class="comment"># curl -X GET 'http://localhost:9200'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"my-node"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"my-cluster"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"2.2.0"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8ff36d139e16f8720f2947ef62c8167a888992fe"</span>,</span><br><span class="line">    <span class="string">"build_timestamp"</span> : <span class="string">"2016-01-27T13:32:39Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"5.4.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="添加记录"><a href="#添加记录" class="headerlink" title="添加记录"></a>添加记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">'http://localhost:9200/tutorial/helloworld/1'</span> <span class="_">-d</span> <span class="string">'&#123; "message": "Hello World!" &#125;'</span></span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _index: "tutorial", </span><br><span class="line">  _type: "helloworld", </span><br><span class="line">  _id: "1", </span><br><span class="line">  _version: 1, </span><br><span class="line">  _shards: &#123;</span><br><span class="line">    total: 2, </span><br><span class="line">    successful: 1, </span><br><span class="line">    failed: 0</span><br><span class="line">  &#125;, </span><br><span class="line">  created: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>tutorial is the index of the data in Elasticsearch.</li>
<li>helloworld is the type.</li>
<li>1 is the id of our entry under the above index and type.</li>
</ul>
<h4 id="获取记录"><a href="#获取记录" class="headerlink" title="获取记录"></a>获取记录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &apos;http://localhost:9200/tutorial/helloworld/1&apos;</span><br></pre></td></tr></table></figure>
<h4 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h4><p>如果要修改已经存在的实体，可以使用 HTTP PUT  请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT &apos;localhost:9200/tutorial/helloworld/1?pretty&apos; -d &apos;&#123;</span><br><span class="line">  &quot;message&quot;: &quot;Hello People!&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>更新成功后返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;tutorial&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;helloworld&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中 <code>_version</code> 会自增（+1），从 1 变成 2</p>
<h4 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE <span class="string">'localhost:9200/tutorial/helloworld/1?pretty'</span></span><br></pre></td></tr></table></figure>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="错误1"><a href="#错误1" class="headerlink" title="错误1"></a>错误1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash-4.1# service elasticsearch start</span><br><span class="line">Starting elasticsearch: log4j:ERROR setFile(null,true) call failed.</span><br><span class="line">java.io.FileNotFoundException: /xxx/elasticsearch/logs/my-cluster.log (Permission denied)</span><br><span class="line">  at java.io.FileOutputStream.open0(Native Method)</span><br><span class="line">  at java.io.FileOutputStream.open(FileOutputStream.java:270)</span><br></pre></td></tr></table></figure>
<p>根据 <a href="https://discuss.elastic.co/t/elasticsearch-unable-to-start/23824/5" target="_blank" rel="external">https://discuss.elastic.co/t/elasticsearch-unable-to-start/23824/5</a>的提示</p>
<blockquote>
<p>Ok so that will have installed the rpm package for Elasticsearch. It will have created an elasticsearch user on your linux OS and when you start the Elasticsearch service it will be running as the elasticsearch user. The problem you are encountering will be that the elasticsearch user does not have permission to write to /var/log/elasticsearch or the files inside it.</p>
</blockquote>
<p>使用 <code>rpm</code> 安装的话，会使用 <code>elasticsearch</code> 这个用户来运行 elasticsearch，因此要修改下  <code>/xxx/elasticsearch</code> 的用户组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod -R  elasticsearch /xxx/elasticsearch</span><br></pre></td></tr></table></figure>
<h4 id="错误2"><a href="#错误2" class="headerlink" title="错误2"></a>错误2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash-4.1<span class="comment"># service elasticsearch start</span></span><br><span class="line">Starting elasticsearch:                                    [  OK  ]</span><br><span class="line">bash-4.1<span class="comment"># Exception in thread "main" BindTransportException[Failed to bind to [9300-9400]]; nested: ChannelException[Failed to bind to: localhost/35.127.0.0:9400]; nested: BindException[Cannot assign requested address];</span></span><br></pre></td></tr></table></figure>
<p>把  <code>/ect/elasticsearch/elasticsearch.yml</code> 里的 localhost -&gt; 127.0.0.1 后</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network.host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>重新启动，不再报错</p>
</div></article><div id="toc" class="toc-article"><strong class="toc-title">目录</strong><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是ElasticSearch？"><span class="toc-number">1.</span> <span class="toc-text">什么是ElasticSearch？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-6-6"><span class="toc-number">2.1.</span> <span class="toc-text">CentOS 6.6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MacOSX"><span class="toc-number">2.2.</span> <span class="toc-text">MacOSX</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">3.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">5.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加记录"><span class="toc-number">5.1.</span> <span class="toc-text">添加记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取记录"><span class="toc-number">5.2.</span> <span class="toc-text">获取记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改记录"><span class="toc-number">5.3.</span> <span class="toc-text">修改记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除记录"><span class="toc-number">5.4.</span> <span class="toc-text">删除记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遇到的问题"><span class="toc-number">6.</span> <span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#错误1"><span class="toc-number">6.1.</span> <span class="toc-text">错误1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#错误2"><span class="toc-number">6.2.</span> <span class="toc-text">错误2</span></a></li></ol></li></ol></div></div></section><footer><div class="paginator"><a href="/2016/03/14/use-elasticsearch-in-rails/" class="prev">PRVE</a><a href="/2015/12/31/how-to-update-git-project-from-fork/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://jiemoon.me">Jiemoon</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>